<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>WonderYard</title>

    <script src="../blockly_uncompressed_vertical.js"></script>
    <script src="../msg/messages.js"></script>
    <script src="../blocks_vertical/vertical_extensions.js"></script>

    <script src="../blocks_common/math.js"></script>
    <script src="../blocks_common/text.js"></script>
    <script src="../blocks_common/colour.js"></script>

    <script src="../javascript_compressed.js"></script>

    <script src="myBlock.js"></script>

    <script src="core.js"></script>

    <script>

      function toXml() {
        var output = document.getElementById('importExport');
        var xml = Blockly.Xml.workspaceToDom(workspace);
        output.value = Blockly.Xml.domToPrettyText(xml);
        output.focus();
        output.select();
        taChange();
      }

      function fromXml() {
        var input = document.getElementById('importExport');
        var xml = Blockly.Xml.textToDom(input.value);
        Blockly.Xml.domToWorkspace(xml, workspace);
        taChange();
      }

      function toCode(lang) {
        var output = document.getElementById('importExport');
        output.value = "function ruleTable(cell, nbhd) {\nswitch(cell) {\n" +
        Blockly[lang].workspaceToCode(workspace) +
        "\n}\nreturn cell;\n}";
        try {
          eval(output.value);

          var states = [];
          if(workspace == null) return states;
          var a = workspace.getAllBlocks();
          for(var i = 0; i < a.length; i++) {
            if (a[i].isInsertionMarker()) {
              continue;
            }
            if(a[i].type === "wy_state_defn" || a[i].type === "wy_state_defn_default") {
              var color = Blockly.JavaScript.valueToCode(a[i], 'COLOR', Blockly.JavaScript.ORDER_MEMBER) || "";
              states.push(color);
            }
          }
          world.setStates(states);
          world.draw(g);
          world.ruleTable = ruleTable;
        } catch(e) {
          alert(e);
        }
        taChange();
      }

      function taChange() {
        var textarea = document.getElementById('importExport');
        if (sessionStorage) {
          sessionStorage.setItem('textarea', textarea.value)
        }
        var valid = true;
        try {
          Blockly.Xml.textToDom(textarea.value);
        } catch (e) {
          valid = false;
        }
        document.getElementById('import').disabled = !valid;
      }

      function setAutoTaChange(state) {
        var checkbox = document.getElementById('autoTaChange');
        checkbox.checked = (state) ? 'checked' : '';
        if (sessionStorage) {
          sessionStorage.setItem('autoTaChange', state);
        }
      }

      var TOOLS = {
        paint: "paint",
        move: "move",
        zoom: "zoom"
      };

      var canvas, g, drawing = false, lastPoint, brushSize = 1, brushCell = 1, world,
      activeTool = TOOLS.paint,
      mouse = {x: 0, y: 0};


      function loop() {
        requestAnimationFrame(loop);
        update();
        draw();
      }

      function update() {
        world.evolve();
      }

      function draw() {
        g.clearRect(0, 0, canvas.width, canvas.height);
        
        //drawBackground();
        world.draw(g);
      }

      function main() {

        canvas = document.getElementById("canvas");
        canvas.width = 256;
        canvas.height = 256;
        g = canvas.getContext("2d");

        canvas.addEventListener("mousedown", function(e) {
          var mouseX = e.clientX - canvas.getBoundingClientRect().left;
          var mouseY = e.clientY - canvas.getBoundingClientRect().top;

          var x = Math.floor((mouseX - world.offsetX) / world.cellSize);
          var y = Math.floor((mouseY - world.offsetY) / world.cellSize);
          if(activeTool == TOOLS.paint) {
            for(var j = Math.ceil(-brushSize/2); j < Math.ceil(brushSize/2); j++) {
              for(var k = Math.ceil(-brushSize/2); k < Math.ceil(brushSize/2); k++) {
                world.setCell(x+j, y+k, brushCell);
              }
            }
            lastPoint = {x: x, y: y};
          }
          drawing = true;
          mouse.x = mouseX;
                mouse.y = mouseY;
          draw();
        });

        canvas.addEventListener("mousemove", function(e) {
          if(drawing) {
            var mouseX = e.clientX - canvas.getBoundingClientRect().left;
            var mouseY = e.clientY - canvas.getBoundingClientRect().top;
            if(activeTool == TOOLS.paint) {
              function distanceBetween(point1, point2) {
                return Math.sqrt(Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2));
              }
              function angleBetween(point1, point2) {
                return Math.atan2(point2.x - point1.x, point2.y - point1.y);
              }

              var x = Math.floor((mouseX - world.offsetX) / world.cellSize);
              var y = Math.floor((mouseY - world.offsetY) / world.cellSize);

              var currentPoint = { x: x, y: y};
              var dist = Math.floor(distanceBetween(lastPoint, currentPoint));
              var angle = angleBetween(lastPoint, currentPoint);

              for (var i = 0; i <= dist; i++) {
                x = Math.floor(lastPoint.x + (Math.sin(angle) * i));
                y = Math.floor(lastPoint.y + (Math.cos(angle) * i));
                for(var j = Math.ceil(-brushSize/2); j < Math.ceil(brushSize/2); j++) {
                  for(var k = Math.ceil(-brushSize/2); k < Math.ceil(brushSize/2); k++) {
                    world.setCell(x+j, y+k, brushCell);
                  }
                }
              }
              lastPoint = currentPoint;
            } else if(activeTool == TOOLS.move) {
                world.offsetX += mouseX - mouse.x;
                world.offsetY += mouseY - mouse.y;
                mouse.x = mouseX;
                mouse.y = mouseY;
            }
            draw();
          }
        });

        canvas.addEventListener("mouseup", function(e) {
          drawing = false;
        }); 

        world = new World(50, 50);        

        draw();

        workspace = Blockly.inject('blocklyDiv', {
          toolbox: document.getElementById('toolbox'),
          media: "../media/",
          scrollbars: true,
          zoom: {
            controls: true,
            wheel: true,
            startScale: 0.75,
            maxScale: 4,
            minScale: 0.25,
            scaleSpeed: 1.1
          },
        });

        var xmlbackground =
        '<xml xmlns="http://www.w3.org/1999/xhtml">' +
          '<variables></variables>' +
          '<block type="wy_state_defn_default" id="background" x="50" y="50">' +
            '<value name="NAME">' +
              '<shadow type="text">' +
                '<field name="TEXT">Background</field>'+
              '</shadow>'+
            '</value>'+
            '<value name="COLOR">'+
              '<shadow type="colour_picker">' +
                '<field name="COLOUR">#000000</field>' +
              '</shadow>' +
            '</value>' +
          '</block>' +
       '</xml>'

        //default background
        Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xmlbackground), workspace);
        workspace.getBlockById("background", workspace).setDeletable(false);

        if (sessionStorage) {
          // Restore previously displayed text.
          var text = sessionStorage.getItem('textarea');
          if (text) {
            document.getElementById('importExport').value = text;
          }
          taChange();
        }

        if (sessionStorage) {
          var checked = sessionStorage.getItem('autoTaChange');
          if (checked === "true") {
            workspace.addChangeListener(toCode.bind(null, "JavaScript"));
            setAutoTaChange(true)
          }
        }

        workspace.addChangeListener(updateWorkspace);
      }
    </script>

    <style>
      html, body {
        height: 100%;
      }

      body {
        overflow: hidden;
      }

      #blocklyDiv {
        float: right;
        height: 95%;
        width: 70%;
      }
    </style>
  </head>

  <body onload="main()">
    <div id="blocklyDiv"></div>

    <xml id="toolbox" style="display: none">
      <block type="wy_state_defn">
        <value name="NAME">
          <shadow type="text">
            <field name="TEXT">Name</field>
          </shadow>
        </value>
        <value name="COLOR">
          <shadow type="colour_picker"></shadow>
        </value>
      </block>
      <block type="wy_rule">
        <value name="EVOLVE_TO">
          <shadow type="wy_rule_menu"></shadow>
        </value>
      </block>
      <block type="wy_condition_between">
        <value name="REF">
          <shadow type="wy_condition_menu"></shadow>
        </value>
        <value name="MIN">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
        <value name="MAX">
          <shadow type="math_number">
            <field name="NUM">8</field>
          </shadow>
        </value>
      </block>
      <!-- <block type="wy_condition_between_custom_nbhd">
        <value name="REF">
          <shadow type="wy_condition_menu"></shadow>
        </value>
        <value name="MIN">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
        <value name="MAX">
          <shadow type="math_number">
            <field name="NUM">8</field>
          </shadow>
        </value>
      </block> -->
      <block type="wy_true_constant"></block>
    </xml>


    <!-- Sidebar -->
    <h1>WonderYard</h1>
    <input type="button" value="Export to XML" onclick="toXml()">
    <input type="button" value="Import from XML" onclick="fromXml()" id="import">
    <input type="button" value="To JavaScript" onclick="toCode('JavaScript')">
    <br><br>
      <input type="checkbox" onclick="setAutoTaChange(this.checked)" id="autoTaChange"> Toggle automatic code generation (after refresh)
    <br><br>
    <textarea id="importExport" style="width: 26%; height: 20em; font-size: 16px; font-family: monospace;" onchange="taChange();" onkeyup="taChange()"></textarea>
    <br><br>
    <input type="button" value="Undo" onclick="workspace.undo()" />
    <input type="button" value="Redo" onclick="workspace.undo(true)" />
    <input type="button" value="TICK" onclick="update(); draw();" />
    <br><canvas id="canvas"></canvas>
    
  </body>
</html>
